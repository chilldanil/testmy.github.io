<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" type="text/css" href="index.css">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.4.1/mapbox-gl.css" rel="stylesheet" />
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <style>
    #overlay {
      display: flex;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(5px);
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }

    #overlay-content {
      background-color: #fff;
      padding: 20px;
      border-radius: 5px;
    }

    #overlay-table {
      margin-bottom: 20px;
    }

    #closeOverlay {
      display: block;
      margin-left: auto;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="row">
      <div class="col-md-12">
        <h1 class="hi_hero"><span id="typing"></span></h1>

        <form id="myForm">
          <div class="form-group">
            <label for="shortTitle">Give us the short title:</label>
            <input type="text" class="form-control" id="shortTitle" placeholder="Enter short title">
          </div>
          <div class="form-group">
            <label for="timeSpotted">Schedule a time you have spotted it the first time:</label>
            <div class="input-group">
              <input type="datetime-local" class="form-control" id="timeSpotted">
              <div class="input-group-append">
                <button type="button" class="btn btn-secondary" id="btnNow">Now</button>
              </div>
            </div>
          </div>
          <div class="form-group">
            <label for="nearestLocality">The nearest locality:</label>
            <div class="input-group">
              <input type="text" class="form-control" id="nearestLocality" placeholder="Enter nearest locality">
              <div class="input-group-append">
                <button type="button" class="btn btn-secondary" id="btnHere">Here</button>
              </div>
            </div>
          </div>
          <div class="form-group">
            <label for="geolocation">Exact Coordinates of Your Location:</label>
            <input type="text" class="form-control" id="geolocation" placeholder="Enter coordinates">
          </div>
          <div class="form-group">
            <label for="picture">Take a picture of the target:</label>
            <input type="file" class="form-control-file" id="picture">
            <div id="image-preview">
              <button type="button" class="btn btn-danger" id="btnRemoveImage">Remove Image</button>
            </div>
          </div>
          <div class="form-group">
            <label for="additionalInfo">Additional Information:</label>
            <textarea class="form-control" id="additionalInfo" rows="5" placeholder="Enter additional information"></textarea>
          </div>

          <button type="button" class="btn btn-primary btn-block" id="submitButton">Submit</button>
        </form>
      </div>
    </div>
  </div>

  <div id="overlay" style="display: none;">
    <div id="overlay-content">
      <h2>Thanks for your work!</h2>
      <table id="overlay-table" class="table">
        <thead>
          <tr>
            <th>Field</th>
            <th>Value</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <button class="btn btn-outline-danger" id="closeOverlay">Close</button>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.4.1/mapbox-gl.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.js"></script>
  <script>
    $(document).ready(function () {
      var now = new Date().toLocaleString('lt-LT', { timeZone: 'Europe/Vilnius' }).slice(0, 16);
      $('#timeSpotted').val(now);

      $('#btnNow').click(function () {
        now = new Date().toLocaleString('lt-LT', { timeZone: 'Europe/Vilnius' }).slice(0, 16);
        $('#timeSpotted').val(now);
      });

      $('#btnHere').click(function () {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(onPositionSuccess, onPositionError);
        } else {
          console.log('Geolocation is not supported by this browser.');
        }
      });

      function onPositionSuccess(position) {
        var lat = position.coords.latitude;
        var lon = position.coords.longitude;

        // Use OSM Nominatim API for reverse geocoding
        var nominatimURL = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}`;

        $.getJSON(nominatimURL)
          .done(function (data) {
            var nearestLocality = data.address.city || data.address.town || data.address.village || data.address.hamlet;
            $('#nearestLocality').val(nearestLocality);
            $('#geolocation').val(`${lat}, ${lon}`);
            showMap(lat, lon);
          })
          .fail(function () {
            console.log('Failed to retrieve reverse geocoding data from OSM Nominatim API.');
          });
      }

      function onPositionError(error) {
        console.log('Error occurred while getting geolocation: ' + error.message);
      }

      // Initialize Mapbox Geocoder
      mapboxgl.accessToken = 'pk.eyJ1IjoiY2hpbGxkYW5pbGwiLCJhIjoiY2xqYmw2bmh1Mjc1czNubnhmd3U4NnNtMyJ9'; // Replace with your Mapbox access token
      var geocoder = new MapboxGeocoder({
        accessToken: mapboxgl.accessToken,
        countries: 'US',
        language: 'en',
        types: 'place',
      });

      document.getElementById('nearestLocality').appendChild(geocoder.onAdd(map));

      // Update coordinates input when a locality is selected
      geocoder.on('result', function (result) {
        var coordinates = result.result.center;
        var latitude = coordinates[1];
        var longitude = coordinates[0];
        $('#geolocation').val(`${latitude}, ${longitude}`);
        showMap(latitude, longitude);
      });

      function showMap(latitude, longitude) {
        var map = L.map('map').setView([latitude, longitude], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          maxZoom: 18,
          attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors',
        }).addTo(map);
        L.marker([latitude, longitude]).addTo(map);
      }
    });
  </script>

  <script>
    $(document).ready(function () {
      $('#submitButton').click(function (event) {
        event.preventDefault(); // Prevent form submission

        // Retrieve form values
        var shortTitle = $('#shortTitle').val();
        var timeSpotted = $('#timeSpotted').val();
        var nearestLocality = $('#nearestLocality').val();
        var geolocation = $('#geolocation').val();
        var additionalInfo = $('#additionalInfo').val();

        // Create a new FormData object
        var formData = new FormData();

        // Append form values to the FormData object
        formData.append('shortTitle', shortTitle);
        formData.append('timeSpotted', timeSpotted);
        formData.append('nearestLocality', nearestLocality);
        formData.append('geolocation', geolocation);
        formData.append('additionalInfo', additionalInfo);

        // Retrieve the image file
        var imageFile = $('#picture')[0].files[0];

        // Append the image file to the FormData object
        formData.append('picture', imageFile);

        // Convert the FormData object to JSON
        var jsonData = JSON.stringify(Object.fromEntries(formData));

        // Display JSON data in the console
        console.log(jsonData);

        // Show the overlay block
        $('#overlay').show();

        // Update the overlay table with the form data
        var tableBody = $('#overlay-table tbody');
        tableBody.empty();
        tableBody.append(createTableRow('Short Title', shortTitle));
        tableBody.append(createTableRow('Time Spotted', timeSpotted));
        tableBody.append(createTableRow('Nearest Locality', nearestLocality));
        tableBody.append(createTableRow('Geolocation', geolocation));
        tableBody.append(createTableRow('Additional Info', additionalInfo));

        // Clear the form fields
        $('#myForm')[0].reset();
      });

      // Close the overlay block
      $('#closeOverlay').click(function () {
        $('#overlay').hide();
      });

      // Helper function to create a table row
      function createTableRow(field, value) {
        return '<tr><td>' + field + '</td><td>' + value + '</td></tr>';
      }
    });
  </script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/typed.js/2.0.11/typed.min.js"></script>
  <script>
    var typed = new Typed('#typing', {
      strings: ['Hi, hero! What are we working on today?!'],
      typeSpeed: 80,
      backSpeed: 30,
      startDelay: 1000,
      loop: false,
      showCursor: true,
      cursorChar: '|',
      onComplete: function (self) {
        self.cursor.remove();
      },
    });
  </script>

  <footer>
    <div class="container">
      <div class="row">
        <div class="col-md-12">
          <h1 style="margin-bottom: -3.5rem;" class="hi_hero">I see the target</h1><span
            style="font-size: 3.5rem">&#x1F441 &#x1F3AF &#x1F4A5</span>
        </div>
      </div>
    </div>
  </footer>
</body>
</html>
